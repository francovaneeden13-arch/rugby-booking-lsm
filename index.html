<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rugby Equipment Booking</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0b5">
  <style>
    :root{
      --bg1:#0ea5e9;
      --bg2:#22c55e;
      --bg3:#a855f7;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#475569;
      --border:rgba(15,23,42,.10);
      --shadow: 0 10px 30px rgba(2,6,23,.10);
      --shadow2: 0 6px 18px rgba(2,6,23,.08);
      --radius: 18px;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 20% 0%, rgba(14,165,233,.28), transparent 55%),
        radial-gradient(900px 600px at 80% 10%, rgba(168,85,247,.22), transparent 55%),
        radial-gradient(900px 600px at 50% 100%, rgba(34,197,94,.18), transparent 55%),
        #f8fafc;
      min-height:100vh;
    }

    .container{
      max-width: 1080px;
      margin: 0 auto;
      padding: 18px;
    }

    .hero{
      position: relative;
      overflow:hidden;
      border-radius: 24px;
      padding: 18px 18px 16px;
      color: white;
      background: linear-gradient(135deg, var(--bg1), var(--bg2) 55%, var(--bg3));
      box-shadow: var(--shadow);
      margin-bottom: 14px;
    }
    .hero::after{
      content:"";
      position:absolute;
      inset:-80px -80px auto auto;
      width: 280px;
      height: 280px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.35), transparent 60%);
      transform: rotate(25deg);
      pointer-events:none;
    }

    .topbar{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
    }

    h1{
      margin:0 0 6px;
      font-size: 22px;
      line-height: 1.1;
      letter-spacing: .2px;
    }

    .sub{
      margin:0;
      color: rgba(255,255,255,.88);
      font-size: 13px;
      line-height: 1.35;
    }

    .meta{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top: 10px;
    }

    .pill{
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.28);
      background: rgba(255,255,255,.12);
      color: rgba(255,255,255,.95);
      backdrop-filter: blur(10px);
      white-space: nowrap;
    }
    .pill.ok{ box-shadow: inset 0 0 0 1px rgba(255,255,255,.16); }
    .pill.off{ border-color: rgba(255,180,180,.55); }
    .pill.lock{ border-color: rgba(255,205,120,.65); }
    .pill.day{ border-color: rgba(200,210,255,.65); }

    .smallbtn{
      border: 0;
      border-radius: 14px;
      padding: 10px 12px;
      background: rgba(255,255,255,.16);
      color: white;
      font-weight: 600;
      cursor:pointer;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.22);
      transition: transform .06s ease, background .15s ease;
      white-space: nowrap;
    }
    .smallbtn:hover{ background: rgba(255,255,255,.22); }
    .smallbtn:active{ transform: translateY(1px); }

    .note{
      font-size: 12px;
      color: rgba(255,255,255,.9);
      margin-top: 8px;
    }

    .tabs{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin: 12px 0 14px;
    }
    .tab{
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 10px 14px;
      cursor: pointer;
      background: rgba(255,255,255,.8);
      backdrop-filter: blur(6px);
      color: var(--text);
      box-shadow: var(--shadow2);
      transition: transform .06s ease, box-shadow .15s ease;
      font-weight: 650;
    }
    .tab:hover{ transform: translateY(-1px); }
    .tab.active{
      border-color: rgba(14,165,233,.35);
      box-shadow: 0 10px 24px rgba(14,165,233,.18);
      background: linear-gradient(135deg, rgba(14,165,233,.18), rgba(34,197,94,.14));
    }

    .grid{
      display:grid;
      gap: 14px;
    }

    .card{
      background: rgba(255,255,255,.82);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 14px;
      box-shadow: var(--shadow2);
      backdrop-filter: blur(8px);
    }

    .card b{
      font-size: 14px;
    }

    .row{
      display:flex;
      flex-wrap:wrap;
      gap: 10px;
      margin-top: 12px;
    }

    button.slot{
      border: 1px solid rgba(15,23,42,.12);
      border-radius: 14px;
      padding: 10px 12px;
      background: white;
      cursor: pointer;
      font-weight: 650;
      color: var(--text);
      box-shadow: 0 8px 16px rgba(2,6,23,.06);
      transition: transform .06s ease, box-shadow .15s ease, opacity .15s ease;
    }
    button.slot:hover{ transform: translateY(-1px); box-shadow: 0 10px 20px rgba(2,6,23,.10); }
    button.slot:active{ transform: translateY(0px); }

    button.slot[disabled]{
      cursor: not-allowed;
      opacity: .60;
      box-shadow: none;
      background: rgba(241,245,249,.9);
    }

    .who{
      font-size: 12px;
      color: var(--muted);
      margin-top: 10px;
      line-height: 1.4;
    }

    @media (max-width: 520px){
      .container{ padding: 14px; }
      h1{ font-size: 20px; }
      button.slot{ padding: 10px 10px; }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="hero">
      <div class="topbar">
        <div>
          <h1>Rugby Equipment Booking</h1>
          <p class="sub">
            Booking days: <b>Tuesday</b> and <b>Thursday</b>. Slots: 14:00–17:00 (30 min).
            Weekly reset. Locked at Monday 00:00.
          </p>

          <div class="meta">
            <span class="pill" id="weekPill">Week: …</span>
            <span class="pill" id="lockPill">…</span>
            <span class="pill day" id="dayPill">Day: …</span>
            <span class="pill" id="netPill">…</span>
          </div>

          <div class="note" id="todayNote"></div>
        </div>

        <button class="smallbtn" id="shareBtn">Share link</button>
      </div>
    </div>

    <div class="tabs" id="dayTabs"></div>
    <div id="app" class="grid"></div>
  </div>

  <script type="module">
    // 1) EDIT THIS: equipment list
    const EQUIPMENT = [
      "Rugby balls (set)",
      "Cones (bag)",
      "Tackle bags (2)",
      "Hit shields (2)",
      "Bibs (set)",
      "Agility ladder",
      "Markers (set)",
      "Pump + needles"
    ];

    // 2) Allowed booking days (Tue/Thu)
    // ISO weekday: Mon=1 ... Sun=7
    const BOOKING_DAYS = [
      { key: "TUE", label: "Tuesday", isoDay: 2 },
      { key: "THU", label: "Thursday", isoDay: 4 }
    ];

    // 3) Time slots: 14:00 to 17:00 every 30 minutes
    function slotMinutes() {
      const out = [];
      const start = 14 * 60, end = 17 * 60;
      for (let m = start; m < end; m += 30) out.push(m);
      return out;
    }
    const SLOT_MINUTES = slotMinutes();
    const fmt = (m) => String(Math.floor(m/60)).padStart(2,"0")+":"+String(m%60).padStart(2,"0");

    // 4) Week window: OPEN from Monday 00:00 until next Monday 00:00
    function weekStartMondayLocal(date = new Date()) {
      const d = new Date(date.getFullYear(), date.getMonth(), date.getDate());
      const dow = d.getDay(); // Sun=0..Sat=6
      const diffToMonday = (dow === 0 ? -6 : 1 - dow); // go back to Monday
      d.setDate(d.getDate() + diffToMonday);
      d.setHours(0, 0, 0, 0); // Monday 00:00
      return d;
    }

    function addDays(date, days) {
      const d = new Date(date);
      d.setDate(d.getDate() + days);
      return d;
    }

    function ymd(date) {
      const y = date.getFullYear();
      const m = String(date.getMonth()+1).padStart(2,"0");
      const d = String(date.getDate()).padStart(2,"0");
      return `${y}-${m}-${d}`;
    }

    function isoWeekdayLocal(date = new Date()) {
      const d = new Date(date.getFullYear(), date.getMonth(), date.getDate());
      const dow = d.getDay(); // Sun=0..Sat=6
      return dow === 0 ? 7 : dow; // Mon=1..Sun=7
    }

    const now = new Date();
    const WEEK_START = weekStartMondayLocal(now);     // this week's Monday 00:00
    const NEXT_WEEK_START = addDays(WEEK_START, 7);   // next Monday 00:00
    const currentIsoDay = isoWeekdayLocal(now);

    // Optional URL params:
    // ?week=YYYY-MM-DD&day=TUE   (week = Monday date for that week)
    const params = new URLSearchParams(location.search);
    const VIEW_WEEK = params.get("week") || ymd(WEEK_START);

    // Parse the viewed week start
    const viewWeekStart = (() => {
      const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(VIEW_WEEK);
      if (!m) return WEEK_START;
      const d = new Date(Number(m[1]), Number(m[2]) - 1, Number(m[3]));
      d.setHours(0,0,0,0);
      return d;
    })();

    // Week is editable ONLY if it's the current week window (locks at Monday 00:00)
    const isWeekOpen = (viewWeekStart.getTime() === WEEK_START.getTime()) && (now < NEXT_WEEK_START);
    const isWeekLocked = !isWeekOpen;

    const requestedDayKey = params.get("day");
    const defaultDayKey = (BOOKING_DAYS.find(d => d.isoDay === currentIsoDay)?.key) || "TUE";
    let ACTIVE_DAY_KEY = (BOOKING_DAYS.some(d => d.key === requestedDayKey) ? requestedDayKey : defaultDayKey);

    // Only allow booking on Tue/Thu AND only on the actual day
    function isDayBookableToday(dayKey) {
      const def = BOOKING_DAYS.find(d => d.key === dayKey);
      if (!def) return false;
      return def.isoDay === currentIsoDay;
    }

    // Pills
    document.getElementById("weekPill").textContent = `Week: ${VIEW_WEEK}`;
    const lockPill = document.getElementById("lockPill");
    lockPill.textContent = isWeekLocked ? "Locked (view only)" : "Open week";
    lockPill.className = "pill " + (isWeekLocked ? "lock" : "ok");

    function setDayPill() {
      const d = BOOKING_DAYS.find(x => x.key === ACTIVE_DAY_KEY);
      document.getElementById("dayPill").textContent = `Day: ${d ? d.label : ACTIVE_DAY_KEY}`;
    }

    // Today note
    const todayFmt = now.toLocaleDateString(undefined, { weekday:"long", year:"numeric", month:"long", day:"numeric" });
    const nextBookable =
      currentIsoDay <= 2 ? "Tuesday" :
      currentIsoDay <= 4 ? "Thursday" : "Tuesday (next week)";
    document.getElementById("todayNote").textContent =
      `Today is ${todayFmt}. Booking days are Tuesday/Thursday. Next bookable day: ${nextBookable}.`;

    // Share button (shares clean link)
    document.getElementById("shareBtn").onclick = async () => {
      const base = location.origin + location.pathname;
      try {
        if (navigator.share) await navigator.share({ title: "Rugby Equipment Booking", url: base });
        else prompt("Copy this link to WhatsApp:", base);
      } catch {}
    };

    // Tabs
    const tabsEl = document.getElementById("dayTabs");
    function renderTabs() {
      tabsEl.innerHTML = "";
      BOOKING_DAYS.forEach(d => {
        const b = document.createElement("button");
        b.className = "tab" + (d.key === ACTIVE_DAY_KEY ? " active" : "");
        const bookable = (!isWeekLocked && isDayBookableToday(d.key));
        b.textContent = d.label + (bookable ? " (today)" : "");
        b.onclick = () => {
          ACTIVE_DAY_KEY = d.key;
          setDayPill();
          renderTabs();
          render();
          history.replaceState(null, "", `?week=${encodeURIComponent(VIEW_WEEK)}&day=${encodeURIComponent(ACTIVE_DAY_KEY)}`);
        };
        tabsEl.appendChild(b);
      });
    }

    setDayPill();
    renderTabs();

    // 5) Firebase config (yours)
    const firebaseConfig = {
      apiKey: "AIzaSyAdL6uRoDFjETPISecWgM83JNPwnJk-lb8",
      authDomain: "rugby-equipment-booking.firebaseapp.com",
      projectId: "rugby-equipment-booking",
      storageBucket: "rugby-equipment-booking.firebasestorage.app",
      messagingSenderId: "248587029060",
      appId: "1:248587029060:web:63fcd7199beaea82b1ca11",
      measurementId: "G-T86Y3LB50Z"
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, doc, runTransaction, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const appFb = initializeApp(firebaseConfig);
    const db = getFirestore(appFb);

    // Doc id includes week(Monday date) + day + equipment index:
    // bookings/{YYYY-MM-DD}_{day}_{index}
    const docId = (i) => `${VIEW_WEEK}_${ACTIVE_DAY_KEY}_${i}`;
    const docRef = (i) => doc(db, "bookings", docId(i));

    const root = document.getElementById("app");
    const state = new Map();

    function canBookNow() {
      if (isWeekLocked) return false;
      return isDayBookableToday(ACTIVE_DAY_KEY); // only Tue/Thu and only on that actual day
    }

    function render() {
      root.innerHTML = "";

      const header = document.createElement("div");
      header.className = "card";
      const dayLabel = BOOKING_DAYS.find(d => d.key === ACTIVE_DAY_KEY)?.label || ACTIVE_DAY_KEY;
      header.innerHTML = `<b>${dayLabel}</b><div class="who">${
        canBookNow()
          ? "Bookings are open for today."
          : (isWeekLocked ? "This week is locked (locks at Monday 00:00)." : "Bookings are view-only right now (not the correct day).")
      }</div>`;
      root.appendChild(header);

      EQUIPMENT.forEach((name, i) => {
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `<b>${name}</b>`;

        const row = document.createElement("div");
        row.className = "row";

        const data = state.get(i) || { slots: {} };

        SLOT_MINUTES.forEach((m) => {
          const t = fmt(m);
          const bookedBy = data.slots?.[t];

          const btn = document.createElement("button");
          btn.className = "slot";
          btn.textContent = bookedBy ? `${t} ✓` : t;
          btn.disabled = !!bookedBy || !canBookNow();

          btn.onclick = async () => {
            if (!canBookNow()) return;

            const coach = prompt(`Book "${name}" on ${dayLabel} at ${t}\nEnter your name:`)?.trim();
            if (!coach) return;

            try {
              await runTransaction(db, async (tx) => {
                if (isWeekLocked) throw new Error("Bookings lock at Monday midnight.");
                if (!isDayBookableToday(ACTIVE_DAY_KEY)) throw new Error("Bookings are only allowed on the actual day (Tue/Thu).");

                const ref = docRef(i);
                const snap = await tx.get(ref);
                const current = snap.exists()
                  ? snap.data()
                  : { equipment: name, week: VIEW_WEEK, day: ACTIVE_DAY_KEY, slots: {} };

                const slotsObj = current.slots || {};
                if (slotsObj[t]) throw new Error(`Already booked by ${slotsObj[t]}`);
                slotsObj[t] = coach;

                tx.set(ref, { equipment: name, week: VIEW_WEEK, day: ACTIVE_DAY_KEY, slots: slotsObj }, { merge: true });
              });
            } catch (e) {
              alert(e?.message || "Could not book. Please try again.");
            }
          };

          row.appendChild(btn);
        });

        card.appendChild(row);

        const who = document.createElement("div");
        who.className = "who";
        const bookedList = Object.entries(data.slots || {})
          .sort((a,b)=>a[0].localeCompare(b[0]))
          .map(([t,coach]) => `${t} – ${coach}`)
          .join(" • ");
        who.textContent = bookedList ? `Booked: ${bookedList}` : "Booked: none";
        card.appendChild(who);

        root.appendChild(card);
      });
    }

    // Live updates: resubscribe when day changes
    let unsubscribers = [];
    function subscribeAll() {
      unsubscribers.forEach(fn => fn && fn());
      unsubscribers = [];
      state.clear();

      EQUIPMENT.forEach((_, i) => {
        const unsub = onSnapshot(docRef(i), (snap) => {
          state.set(i, snap.exists() ? snap.data() : { equipment: EQUIPMENT[i], week: VIEW_WEEK, day: ACTIVE_DAY_KEY, slots: {} });
          render();
        });
        unsubscribers.push(unsub);
      });
      render();
    }

    // Re-subscribe when tabs change
    const origReplace = history.replaceState.bind(history);
    history.replaceState = (...args) => { origReplace(...args); subscribeAll(); };

    // Network pill + service worker
    const net = document.getElementById("netPill");
    function updateNet() {
      const online = navigator.onLine;
      net.textContent = online ? "Online" : "Offline (view only)";
      net.className = "pill " + (online ? "ok" : "off");
    }
    window.addEventListener("online", updateNet);
    window.addEventListener("offline", updateNet);
    updateNet();

    if ("serviceWorker" in navigator) navigator.serviceWorker.register("./sw.js");

    subscribeAll();
  </script>
</body>
</html>
