<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rugby Equipment Booking</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0ea5e9">
  <style>
    :root{
      --bg1:#0ea5e9;
      --bg2:#22c55e;
      --bg3:#a855f7;
      --text:#0f172a;
      --muted:#475569;
      --border:rgba(15,23,42,.10);
      --shadow: 0 10px 30px rgba(2,6,23,.10);
      --shadow2: 0 6px 18px rgba(2,6,23,.08);
      --radius: 18px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 20% 0%, rgba(14,165,233,.28), transparent 55%),
        radial-gradient(900px 600px at 80% 10%, rgba(168,85,247,.22), transparent 55%),
        radial-gradient(900px 600px at 50% 100%, rgba(34,197,94,.18), transparent 55%),
        #f8fafc;
      min-height:100vh;
    }
    .container{ max-width:1080px; margin:0 auto; padding:18px; }
    .hero{
      position:relative; overflow:hidden; border-radius:24px;
      padding:18px 18px 16px; color:white;
      background: linear-gradient(135deg, var(--bg1), var(--bg2) 55%, var(--bg3));
      box-shadow: var(--shadow); margin-bottom:14px;
    }
    .hero::after{
      content:""; position:absolute; inset:-80px -80px auto auto;
      width:280px; height:280px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.35), transparent 60%);
      transform: rotate(25deg); pointer-events:none;
    }

    /* ✅ MOBILE FIX: topbar stacks on small screens */
    .topbar{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
    }

    h1{ margin:0 0 6px; font-size:22px; line-height:1.1; letter-spacing:.2px; }
    .sub{ margin:0; color:rgba(255,255,255,.88); font-size:13px; line-height:1.35; }
    .meta{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
    .pill{
      font-size:12px; padding:6px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.28);
      background:rgba(255,255,255,.12);
      color:rgba(255,255,255,.95);
      backdrop-filter: blur(10px);
      white-space:nowrap;
    }
    .pill.ok{ border-color: rgba(200,255,220,.55); }
    .pill.off{ border-color: rgba(255,180,180,.55); }
    .pill.lock{ border-color: rgba(255,205,120,.65); }
    .pill.day{ border-color: rgba(200,210,255,.65); }

    .actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap; /* allow wrap so buttons never cut off */
      justify-content:flex-end;
    }

    .smallbtn{
      border:0; border-radius:14px; padding:10px 12px;
      background: rgba(255,255,255,.16); color:white;
      font-weight:900; cursor:pointer;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.22);
      transition: transform .06s ease, background .15s ease;
      white-space: nowrap;
    }
    .smallbtn:hover{ background: rgba(255,255,255,.22); }
    .smallbtn:active{ transform: translateY(1px); }

    .note{ font-size:12px; color:rgba(255,255,255,.9); margin-top:8px; }

    .tabs{ display:flex; gap:10px; flex-wrap:wrap; margin:12px 0 14px; }
    .tab{
      border:1px solid var(--border);
      border-radius:999px; padding:10px 14px;
      cursor:pointer; background: rgba(255,255,255,.82);
      backdrop-filter: blur(6px); color: var(--text);
      box-shadow: var(--shadow2);
      transition: transform .06s ease, box-shadow .15s ease;
      font-weight:900;
    }
    .tab:hover{ transform: translateY(-1px); }
    .tab.active{
      border-color: rgba(14,165,233,.35);
      box-shadow: 0 10px 24px rgba(14,165,233,.18);
      background: linear-gradient(135deg, rgba(14,165,233,.18), rgba(34,197,94,.14));
    }

    .grid{ display:grid; gap:14px; }

    .card{
      background: rgba(255,255,255,.86);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 14px;
      box-shadow: var(--shadow2);
      backdrop-filter: blur(8px);
    }

    .titleRow{ display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; }
    .titleRow b{ font-size:14px; }
    .hint{ font-size:12px; color: var(--muted); }

    .row{ display:flex; flex-wrap:wrap; gap:10px; margin-top:12px; }

    button.slot{
      border: 1px solid rgba(15,23,42,.12);
      border-radius: 14px;
      padding: 10px 12px;
      background: white;
      cursor: pointer;
      font-weight: 950;
      color: var(--text);
      box-shadow: 0 8px 16px rgba(2,6,23,.06);
      transition: transform .06s ease, box-shadow .15s ease, opacity .15s ease;
    }
    button.slot:hover{ transform: translateY(-1px); box-shadow: 0 10px 20px rgba(2,6,23,.10); }
    button.slot:active{ transform: translateY(0px); }
    button.slot[disabled]{ cursor:not-allowed; opacity:.55; box-shadow:none; background: rgba(241,245,249,.9); }

    button.slot.full{
      border-color: rgba(245,158,11,.45);
      background: linear-gradient(135deg, rgba(245,158,11,.12), rgba(14,165,233,.06));
    }

    .who{ font-size:12px; color: var(--muted); margin-top:10px; line-height:1.45; }

    /* ✅ PHONE: stack header + wrap buttons into rows */
    @media (max-width: 680px){
      .topbar{ flex-direction: column; align-items: stretch; }
      .actions{ width:100%; justify-content:flex-start; }
      .smallbtn{ flex: 1 1 140px; text-align:center; }
    }

    @media (max-width: 520px){
      .container{ padding:14px; }
      h1{ font-size:20px; }
      button.slot{ padding:10px 10px; }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="hero">
      <div class="topbar">
        <div>
          <h1>Rugby Equipment Booking</h1>
          <p class="sub">
            Book Tue/Thu equipment in 30-minute slots (14:00–17:00).
            Future weeks: book anytime. Current week: bookings & cancellations close 3 hours before each slot.
            Tap a time to book a quantity. Tap again to cancel your quantity.
          </p>

          <div class="meta">
            <span class="pill" id="weekPill">Week: …</span>
            <span class="pill" id="lockPill">…</span>
            <span class="pill day" id="dayPill">Day: …</span>
            <span class="pill" id="netPill">…</span>
          </div>

          <div class="note" id="todayNote"></div>
        </div>

        <!-- Order optimized for mobile (Share first) -->
        <div class="actions">
          <button class="smallbtn" id="shareBtn">Share link</button>
          <button class="smallbtn" id="prevWeekBtn">◀ Week</button>
          <button class="smallbtn" id="nextWeekBtn">Week ▶</button>
          <button class="smallbtn" id="clearMineBtn">Clear my bookings</button>
        </div>
      </div>
    </div>

    <div class="tabs" id="dayTabs"></div>
    <div id="app" class="grid"></div>
  </div>

  <script type="module">
    // =========================
    // SETTINGS
    // =========================
    const CUTOFF_HOURS = 3;

    // ✅ EDIT THIS: equipment list + stock per item
    const EQUIPMENT = [
      { name: "Rugby balls (set)", stock: 6 },
      { name: "Cones (bag)", stock: 4 },
      { name: "Tackle bags", stock: 2 },
      { name: "Hit shields", stock: 2 },
      { name: "Bibs (set)", stock: 3 },
      { name: "Agility ladder", stock: 2 },
      { name: "Markers (set)", stock: 4 },
      { name: "Pump + needles", stock: 1 }
    ];

    const BOOKING_DAYS = [
      { key: "TUE", label: "Tuesday" },
      { key: "THU", label: "Thursday" }
    ];

    // Slots 14:00–17:00 every 30 minutes
    function slotMinutes() {
      const out = [];
      const start = 14 * 60, end = 17 * 60;
      for (let m = start; m < end; m += 30) out.push(m);
      return out;
    }
    const SLOT_MINUTES = slotMinutes();
    const fmt = (m) => String(Math.floor(m/60)).padStart(2,"0")+":"+String(m%60).padStart(2,"0");

    // =========================
    // DATE HELPERS
    // =========================
    function nowDate() { return new Date(); }

    function weekStartMondayLocal(date = new Date()) {
      const d = new Date(date.getFullYear(), date.getMonth(), date.getDate());
      const dow = d.getDay(); // Sun=0..Sat=6
      const diffToMonday = (dow === 0 ? -6 : 1 - dow);
      d.setDate(d.getDate() + diffToMonday);
      d.setHours(0, 0, 0, 0);
      return d;
    }

    function addDays(date, days) {
      const d = new Date(date);
      d.setDate(d.getDate() + days);
      return d;
    }

    function ymd(date) {
      const y = date.getFullYear();
      const m = String(date.getMonth()+1).padStart(2,"0");
      const d = String(date.getDate()).padStart(2,"0");
      return `${y}-${m}-${d}`;
    }

    function parseYmd(str) {
      const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(str || "");
      if (!m) return null;
      const d = new Date(Number(m[1]), Number(m[2]) - 1, Number(m[3]));
      d.setHours(0,0,0,0);
      return d;
    }

    function formatWeekLabel(mondayDate) {
      return mondayDate.toLocaleDateString(undefined, { year:"numeric", month:"short", day:"numeric" });
    }

    function dayOffsetFromMonday(dayKey) {
      // Tuesday = +1, Thursday = +3 (from Monday)
      if (dayKey === "TUE") return 1;
      if (dayKey === "THU") return 3;
      return null;
    }

    function slotStartDateTime(viewWeekStart, dayKey, timeHHMM) {
      const off = dayOffsetFromMonday(dayKey);
      if (off === null) return null;
      const [hh, mm] = timeHHMM.split(":").map(Number);
      const d = new Date(viewWeekStart);
      d.setDate(d.getDate() + off);
      d.setHours(hh, mm, 0, 0);
      return d;
    }

    // =========================
    // URL PARAMS (week + day)
    // week = Monday date YYYY-MM-DD
    // =========================
    const params = new URLSearchParams(location.search);

    const CURRENT_WEEK_START = weekStartMondayLocal(nowDate());
    const DEFAULT_WEEK = ymd(CURRENT_WEEK_START);

    const VIEW_WEEK = params.get("week") || DEFAULT_WEEK;
    const viewWeekStart = parseYmd(VIEW_WEEK) || CURRENT_WEEK_START;

    const requestedDayKey = params.get("day");
    let ACTIVE_DAY_KEY = (BOOKING_DAYS.some(d => d.key === requestedDayKey) ? requestedDayKey : "TUE");

    // Past weeks locked; current+future bookable (with cutoff for current)
    const isWeekLocked = viewWeekStart.getTime() < CURRENT_WEEK_START.getTime();
    const isCurrentWeek = viewWeekStart.getTime() === CURRENT_WEEK_START.getTime();

    // =========================
    // UI PILLS
    // =========================
    const weekPill = document.getElementById("weekPill");
    const lockPill = document.getElementById("lockPill");

    weekPill.textContent = `Week: ${VIEW_WEEK} (Mon ${formatWeekLabel(viewWeekStart)})`;
    lockPill.textContent = isWeekLocked ? "Locked (past week)" : (isCurrentWeek ? "Current week" : "Future week");
    lockPill.className = "pill " + (isWeekLocked ? "lock" : "ok");

    function setDayPill() {
      const d = BOOKING_DAYS.find(x => x.key === ACTIVE_DAY_KEY);
      document.getElementById("dayPill").textContent = `Day: ${d ? d.label : ACTIVE_DAY_KEY}`;
    }
    setDayPill();

    // Network pill
    const net = document.getElementById("netPill");
    function updateNet() {
      const online = navigator.onLine;
      net.textContent = online ? "Online" : "Offline (view only)";
      net.className = "pill " + (online ? "ok" : "off");
    }
    window.addEventListener("online", updateNet);
    window.addEventListener("offline", updateNet);
    updateNet();

    // Today note
    const today = nowDate();
    const todayFmt = today.toLocaleDateString(undefined, { weekday:"long", year:"numeric", month:"long", day:"numeric" });
    document.getElementById("todayNote").textContent =
      `Today is ${todayFmt}. Future weeks: book anytime. This week: closes ${CUTOFF_HOURS} hours before slot time.`;

    // =========================
    // WEEK NAV
    // =========================
    function goToWeek(mondayDate) {
      const week = ymd(mondayDate);
      const next = new URLSearchParams(location.search);
      next.set("week", week);
      next.set("day", ACTIVE_DAY_KEY);
      location.search = "?" + next.toString();
    }
    document.getElementById("prevWeekBtn").onclick = () => goToWeek(addDays(viewWeekStart, -7));
    document.getElementById("nextWeekBtn").onclick = () => goToWeek(addDays(viewWeekStart, 7));

    // Share base link
    document.getElementById("shareBtn").onclick = async () => {
      const base = location.origin + location.pathname;
      try {
        if (navigator.share) await navigator.share({ title: "Rugby Equipment Booking", url: base });
        else prompt("Copy this link to WhatsApp:", base);
      } catch {}
    };

    // =========================
    // DAY TABS
    // =========================
    const tabsEl = document.getElementById("dayTabs");
    function renderTabs() {
      tabsEl.innerHTML = "";
      BOOKING_DAYS.forEach(d => {
        const b = document.createElement("button");
        b.className = "tab" + (d.key === ACTIVE_DAY_KEY ? " active" : "");
        b.textContent = d.label;
        b.onclick = () => {
          ACTIVE_DAY_KEY = d.key;
          setDayPill();
          renderTabs();
          subscribeAll();
          const next = new URLSearchParams(location.search);
          next.set("week", VIEW_WEEK);
          next.set("day", ACTIVE_DAY_KEY);
          history.replaceState(null, "", "?" + next.toString());
        };
        tabsEl.appendChild(b);
      });
    }
    renderTabs();

    // =========================
    // RULES
    // =========================
    function canModifySlot(dayKey, timeHHMM) {
      if (isWeekLocked) return false;
      if (dayOffsetFromMonday(dayKey) === null) return false;

      // Future weeks: always allowed
      if (!isCurrentWeek) return true;

      // Current week: allowed until cutoff
      const start = slotStartDateTime(viewWeekStart, dayKey, timeHHMM);
      if (!start) return false;
      const cutoff = new Date(start.getTime() - CUTOFF_HOURS * 60 * 60 * 1000);
      return nowDate() < cutoff;
    }

    // Slots store: array of {name, qty}
    function normalizeSlotValue(v) {
      if (Array.isArray(v)) return v.filter(x => x && typeof x.name === "string" && Number.isFinite(Number(x.qty)));
      if (typeof v === "string" && v.trim()) return [{ name: v.trim(), qty: 1 }]; // legacy support
      return [];
    }

    function compactBookings(arr) {
      const m = new Map();
      for (const x of arr) {
        const n = (x.name || "").trim();
        const q = Math.max(0, Number(x.qty) || 0);
        if (!n || !q) continue;
        m.set(n, (m.get(n) || 0) + q);
      }
      return Array.from(m.entries()).map(([name, qty]) => ({ name, qty }));
    }

    function sumQty(arr) {
      return arr.reduce((acc, x) => acc + Math.max(0, Number(x.qty) || 0), 0);
    }

    function qtyBookedByName(arr, name) {
      const n = (name || "").trim();
      return arr.reduce((acc, x) => acc + ((x.name === n) ? (Number(x.qty) || 0) : 0), 0);
    }

    // =========================
    // FIREBASE
    // =========================
    const firebaseConfig = {
      apiKey: "AIzaSyAdL6uRoDFjETPISecWgM83JNPwnJk-lb8",
      authDomain: "rugby-equipment-booking.firebaseapp.com",
      projectId: "rugby-equipment-booking",
      storageBucket: "rugby-equipment-booking.firebasestorage.app",
      messagingSenderId: "248587029060",
      appId: "1:248587029060:web:63fcd7199beaea82b1ca11",
      measurementId: "G-T86Y3LB50Z"
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, doc, runTransaction, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const appFb = initializeApp(firebaseConfig);
    const db = getFirestore(appFb);

    // bookings/{YYYY-MM-DD}_{day}_{index}
    const docId = (i) => `${VIEW_WEEK}_${ACTIVE_DAY_KEY}_${i}`;
    const docRef = (i) => doc(db, "bookings", docId(i));

    // =========================
    // RENDERING
    // =========================
    const root = document.getElementById("app");
    const state = new Map(); // i -> {slots:{}}

    function render() {
      root.innerHTML = "";

      const dayLabel = BOOKING_DAYS.find(d => d.key === ACTIVE_DAY_KEY)?.label || ACTIVE_DAY_KEY;

      const info = document.createElement("div");
      info.className = "card";
      let msg = "";
      if (isWeekLocked) msg = "This is a past week (locked).";
      else if (isCurrentWeek) msg = `Current week: bookings & cancellations close ${CUTOFF_HOURS} hours before each slot.`;
      else msg = "Future week: bookings & cancellations are open anytime.";
      info.innerHTML = `<div class="titleRow"><b>${dayLabel}</b><span class="hint">${msg}</span></div>`;
      root.appendChild(info);

      EQUIPMENT.forEach((equip, i) => {
        const card = document.createElement("div");
        card.className = "card";

        const header = document.createElement("div");
        header.className = "titleRow";
        header.innerHTML = `<b>${equip.name}</b><span class="hint">Stock: ${equip.stock} • Tap a time to book/cancel quantity</span>`;
        card.appendChild(header);

        const row = document.createElement("div");
        row.className = "row";

        const data = state.get(i) || { slots: {} };

        SLOT_MINUTES.forEach((m) => {
          const t = fmt(m);
          const allowed = canModifySlot(ACTIVE_DAY_KEY, t);

          const slotArr = compactBookings(normalizeSlotValue(data.slots?.[t]));
          const bookedTotal = sumQty(slotArr);
          const remaining = Math.max(0, equip.stock - bookedTotal);
          const isFull = remaining <= 0;

          const btn = document.createElement("button");
          btn.className = "slot" + (isFull ? " full" : "");
          btn.textContent = isFull ? `${t} (Full)` : `${t} (${remaining} left)`;

          const hasAnyBooking = bookedTotal > 0;
          btn.disabled = !allowed || (!hasAnyBooking && remaining <= 0);

          btn.onclick = async () => {
            if (!canModifySlot(ACTIVE_DAY_KEY, t)) {
              alert("This slot is closed (past week or within 3 hours of start time).");
              return;
            }

            const name = prompt(
              `Equipment: ${equip.name}\nDay: ${dayLabel}\nTime: ${t}\n\nEnter your name (required):`
            )?.trim();
            if (!name) return;

            const currentSlot = slotArr; // already compacted
            const already = qtyBookedByName(currentSlot, name);
            const curBookedTotal = bookedTotal;
            const curRemaining = Math.max(0, equip.stock - curBookedTotal);

            let action = "BOOK";
            if (already > 0) {
              const wantCancel = confirm(
                `You currently have ${already} booked for this slot.\n\nOK = Cancel quantity\nCancel = Book more (if available)`
              );
              action = wantCancel ? "CANCEL" : "BOOK";
            }

            if (action === "BOOK") {
              if (curRemaining <= 0) {
                alert("This slot is full. You can only cancel existing bookings.");
                return;
              }
              const qtyStr = prompt(`How many do you want to book? (1 to ${curRemaining})`)?.trim();
              if (!qtyStr) return;
              const qty = Number(qtyStr);
              if (!Number.isFinite(qty) || qty < 1 || qty > curRemaining) {
                alert("Invalid quantity.");
                return;
              }

              try {
                await runTransaction(db, async (tx) => {
                  if (!canModifySlot(ACTIVE_DAY_KEY, t)) throw new Error("This slot is closed.");

                  const ref = docRef(i);
                  const snap = await tx.get(ref);
                  const docData = snap.exists()
                    ? snap.data()
                    : { equipment: equip.name, week: VIEW_WEEK, day: ACTIVE_DAY_KEY, slots: {} };

                  const slotsObj = docData.slots || {};
                  const slotArrTx = compactBookings(normalizeSlotValue(slotsObj[t]));
                  const bookedTotalTx = sumQty(slotArrTx);
                  const remainingTx = Math.max(0, equip.stock - bookedTotalTx);

                  if (qty > remainingTx) throw new Error(`Only ${remainingTx} left for this slot.`);

                  slotArrTx.push({ name, qty });
                  slotsObj[t] = compactBookings(slotArrTx);

                  tx.set(ref, { equipment: equip.name, week: VIEW_WEEK, day: ACTIVE_DAY_KEY, slots: slotsObj }, { merge: true });
                });
              } catch (e) {
                alert(e?.message || "Could not book. Please try again.");
              }
              return;
            }

            // CANCEL
            const qtyStr = prompt(`How many do you want to cancel? (1 to ${already})`)?.trim();
            if (!qtyStr) return;
            const qtyCancel = Number(qtyStr);
            if (!Number.isFinite(qtyCancel) || qtyCancel < 1 || qtyCancel > already) {
              alert("Invalid quantity.");
              return;
            }

            try {
              await runTransaction(db, async (tx) => {
                if (!canModifySlot(ACTIVE_DAY_KEY, t)) throw new Error("This slot is closed.");

                const ref = docRef(i);
                const snap = await tx.get(ref);
                if (!snap.exists()) throw new Error("No bookings found.");

                const docData = snap.data();
                const slotsObj = docData.slots || {};
                const slotArrTx = compactBookings(normalizeSlotValue(slotsObj[t]));
                const alreadyTx = qtyBookedByName(slotArrTx, name);

                if (alreadyTx < qtyCancel) throw new Error("Booking changed. Please try again.");

                const updated = [];
                for (const x of slotArrTx) {
                  if (x.name !== name) { updated.push(x); continue; }
                  const newQty = x.qty - qtyCancel;
                  if (newQty > 0) updated.push({ name: x.name, qty: newQty });
                }

                slotsObj[t] = compactBookings(updated);
                tx.set(ref, { slots: slotsObj }, { merge: true });
              });
            } catch (e) {
              alert(e?.message || "Could not cancel. Please try again.");
            }
          };

          row.appendChild(btn);
        });

        card.appendChild(row);

        const who = document.createElement("div");
        who.className = "who";

        const lines = [];
        for (const mm of SLOT_MINUTES) {
          const tt = fmt(mm);
          const slotArr2 = compactBookings(normalizeSlotValue(data.slots?.[tt]));
          if (!slotArr2.length) continue;

          const parts = slotArr2
            .sort((a,b)=>a.name.localeCompare(b.name))
            .map(x => `${x.name} (${x.qty})`)
            .join(", ");

          lines.push(`${tt} – ${parts}`);
        }

        who.textContent = lines.length ? `Booked: ${lines.join(" • ")}` : "Booked: none";
        card.appendChild(who);

        root.appendChild(card);
      });
    }

    // =========================
    // CLEAR MY BOOKINGS (coach only)
    // =========================
    async function clearMyBookings(scope) {
      if (isWeekLocked) {
        alert("Past weeks are locked and cannot be changed.");
        return;
      }

      const coachName = prompt("Enter your name to clear ONLY your bookings:")?.trim();
      if (!coachName) return;

      const daysToClear = (scope === "DAY") ? [ACTIVE_DAY_KEY] : BOOKING_DAYS.map(d => d.key);

      let removed = 0;
      let skipped = 0;

      for (const dayKey of daysToClear) {
        for (let i = 0; i < EQUIPMENT.length; i++) {
          const ref = doc(db, "bookings", `${VIEW_WEEK}_${dayKey}_${i}`);

          try {
            await runTransaction(db, async (tx) => {
              const snap = await tx.get(ref);
              if (!snap.exists()) return;

              const data = snap.data();
              const slots = data.slots || {};
              let changed = false;

              for (const [time, value] of Object.entries(slots)) {
                const arr = compactBookings(normalizeSlotValue(value));
                const mine = qtyBookedByName(arr, coachName);
                if (!mine) continue;

                // Respect cutoff per-slot
                if (!canModifySlot(dayKey, time)) {
                  skipped++;
                  continue;
                }

                // Remove coach entirely from this slot
                const updated = arr.filter(x => x.name !== coachName);
                slots[time] = compactBookings(updated);
                changed = true;
                removed += mine;
              }

              if (changed) tx.set(ref, { slots }, { merge: true });
            });
          } catch {
            // keep going
          }
        }
      }

      let msg = `Done. Removed ${removed} item(s) booked under "${coachName}".`;
      if (skipped) msg += ` Skipped ${skipped} slot(s) because they are within the 3-hour cutoff.`;
      alert(msg);
    }

    document.getElementById("clearMineBtn").onclick = async () => {
      const clearDay = confirm(
        "OK = Clear ONLY your bookings for this day (current tab)\nCancel = Clear ONLY your bookings for the full week (Tue + Thu)"
      );
      await clearMyBookings(clearDay ? "DAY" : "WEEK");
    };

    // =========================
    // LIVE UPDATES
    // =========================
    let unsubscribers = [];
    function subscribeAll() {
      unsubscribers.forEach(fn => fn && fn());
      unsubscribers = [];
      state.clear();

      EQUIPMENT.forEach((_, i) => {
        const unsub = onSnapshot(docRef(i), (snap) => {
          state.set(i, snap.exists()
            ? snap.data()
            : { equipment: EQUIPMENT[i].name, week: VIEW_WEEK, day: ACTIVE_DAY_KEY, slots: {} }
          );
          render();
        });
        unsubscribers.push(unsub);
      });

      render();
    }

    // Register SW
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("./sw.js");
    }

    subscribeAll();
  </script>
</body>
</html>
